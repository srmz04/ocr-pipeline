<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Captura RÃ¡pida - VacunaciÃ³n</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css?v=2">
</head>

<body>

    <!-- Header -->
    <header class="header">
        <h1 class="header-title">ğŸ“· Captura</h1>
        <div class="header-actions">
            <button id="historyBtn" class="icon-btn" title="Historial">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button id="helpBtn" class="icon-btn" title="Ayuda">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
        </div>
    </header>
    <div style="text-align: center; font-size: 10px; color: #666;">v2.2 (TD FIX)</div>

    <!-- Compact Instructions (at top, minimal) -->
    <div class="compact-instructions">
        <span>ğŸ“ 15-20cm</span>
        <span>ğŸ’¡ Buena luz</span>
        <span>ğŸ“„ Superficie plana</span>
    </div>

    <!-- Split Selectors Container -->
    <div class="split-container">
        <!-- Producto Selector (Left) -->
        <section class="selector half-width">
            <label class="selector-label">PRODUCTO</label>
            <div class="chip-list" id="productoSelector">
                <button class="chip" data-producto="VITAMINAS ACD">VITAMINAS ACD</button>
                <button class="chip" data-producto="BCG">BCG</button>
                <button class="chip" data-producto="Hepatitis B">Hepatitis B</button>
                <button class="chip" data-producto="Hexavalente">Hexavalente</button>
                <button class="chip" data-producto="Rotavirus">Rotavirus</button>
                <button class="chip" data-producto="NeumocÃ³cica Conjugada">NeumocÃ³cica</button>
                <button class="chip" data-producto="Influenza">Influenza</button>
                <button class="chip" data-producto="SRP (Triple Viral)">SRP</button>
                <button class="chip" data-producto="DPT">DPT</button>
                <button class="chip" data-producto="VPH">VPH</button>
                <button class="chip" data-producto="COVID">COVID</button>
                <button class="chip" data-producto="SR">SR</button>
                <button class="chip" data-producto="TD">TD</button>
            </div>
            <!-- Custom Product Input (Hidden by default) -->
            <input type="text" id="customProductoInput" class="custom-input hidden" placeholder="Escribe el nombre...">
        </section>

        <!-- Dosis Selector (Right) -->
        <section class="selector half-width">
            <label class="selector-label">DOSIS</label>
            <div class="chip-list" id="dosisSelector">
                <button class="chip" data-dosis="1Âª">1Âª</button>
                <button class="chip" data-dosis="2Âª">2Âª</button>
                <button class="chip" data-dosis="3Âª">3Âª</button>
                <button class="chip" data-dosis="Refuerzo">Refuerzo</button>
                <button class="chip" data-dosis="Ãšnica">Ãšnica</button>
            </div>
        </section>
    </div>

    <!-- Add to Queue Button -->
    <button id="addToQueueBtn" class="add-queue-button" disabled>
        + AGREGAR A LISTA
    </button>

    <!-- Product Queue Display -->
    <div id="queueContainer" class="queue-container hidden">
        <label class="queue-label">ğŸ“‹ Productos a registrar:</label>
        <div id="queueList" class="queue-list">
            <!-- Queue items will be added here dynamically -->
        </div>
        <button id="clearQueueBtn" class="clear-queue-button">ğŸ—‘ï¸ Limpiar</button>
    </div>

    <!-- Native Camera Capture Section -->
    <div class="native-capture-section">
        <label for="nativeCameraInput" class="native-capture-button">
            ğŸ“· TOMAR FOTO
        </label>
        <input type="file" id="nativeCameraInput" accept="image/*" capture="environment" hidden>
        <p id="deviceTip" class="device-tip-inline"></p>
    </div>

    <!-- Preview Section (hidden until photo taken) -->
    <div id="previewSection" class="preview-section hidden">
        <img id="previewImage" class="preview-image" alt="Vista previa">
        <div class="preview-info">
            <span id="previewSize" class="preview-size"></span>
            <span id="previewQuality" class="preview-quality"></span>
        </div>
        <div class="preview-actions">
            <button id="retakeBtn" class="action-btn secondary">
                ğŸ”„ Otra vez
            </button>
            <button id="confirmBtn" class="action-btn primary">
                âœ… Usar esta
            </button>
        </div>
    </div>

    <!-- iOS Standalone Warning (hidden by default) -->
    <div id="iosWarning" class="ios-warning hidden">
        <p>âš ï¸ Si la cÃ¡mara no abre, <a href="#" id="openInSafari">abre en Safari</a></p>
    </div>

    <!-- Status Indicator -->
    <div id="status" class="status status-ready">
        ğŸŸ¢ Listo para capturar
    </div>

    <!-- Offline Indicator Bar (Hidden when no pending items) -->
    <div id="offlineBar" class="offline-bar hidden">
        <span class="offline-status">
            <span id="offlineIcon">ğŸ“´</span>
            <span id="offlinePendingText">0 pendientes</span>
        </span>
        <div class="offline-actions">
            <button id="syncBtn" class="offline-btn sync-btn" title="Sincronizar">
                ğŸ”„ Sincronizar
            </button>
            <button id="downloadZipBtn" class="offline-btn download-btn" title="Descargar ZIP">
                ğŸ“¦ Descargar ZIP
            </button>
        </div>
    </div>

    <!-- Stats Footer -->
    <footer class="footer">
        <span>Hoy: <strong id="countToday">0</strong></span>
        <span>Ãšltima: <strong id="lastTime">--:--</strong></span>
    </footer>

    <!-- History Sidebar (Hidden by default) -->
    <aside id="historySidebar" class="sidebar hidden">
        <div class="sidebar-header">
            <h2>Ãšltimas capturas</h2>
            <button id="closeSidebar" class="icon-btn">âœ•</button>
        </div>
        <div id="historyList" class="history-list">
            <!-- Populated dynamically -->
        </div>
    </aside>

    <!-- Help Modal (Hidden by default) -->
    <div id="helpModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“– GuÃ­a RÃ¡pida</h2>
                <button id="closeHelp" class="icon-btn">âœ•</button>
            </div>
            <div class="modal-body">
                <h3>Pasos:</h3>
                <ol>
                    <li>Selecciona el <strong>biolÃ³gico</strong> aplicado</li>
                    <li>Selecciona la <strong>dosis</strong></li>
                    <li>Encuadra la <strong>credencial o cartilla</strong></li>
                    <li>Espera seÃ±al verde ğŸŸ¢</li>
                    <li>Presiona <strong>CAPTURAR</strong></li>
                </ol>

                <h3>Indicadores:</h3>
                <ul>
                    <li>ğŸŸ¢ <strong>Verde</strong>: Listo para capturar</li>
                    <li>ğŸŸ¡ <strong>Amarillo</strong>: Mejora iluminaciÃ³n/enfoque</li>
                    <li>ğŸ”´ <strong>Rojo</strong>: No se puede capturar</li>
                </ul>

                <h3>Tips:</h3>
                <ul>
                    <li>Usa buena iluminaciÃ³n natural</li>
                    <li>MantÃ©n el documento plano</li>
                    <li>Evita reflejos y sombras</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>Subiendo...</p>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast hidden"></div>

    <!-- Scripts -->
    <script src="config.js?v=2"></script>
    <script src="google-api.js"></script>
    <script src="camera.js"></script>
    <script src="validator.js"></script>
    <script src="uploader.js"></script>
    <script src="offline-manager.js"></script>
    <!-- Tesseract.js OCR Engine (100% client-side, no cost) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="ocr-tesseract.js"></script>
    <script src="app.js?v=2"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // FORCE UNREGISTER TO CLEAR CACHE
                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        console.log('Unregistering SW:', registration);
                        registration.unregister();
                    }
                    if (registrations.length > 0) {
                        alert('âœ… ActualizaciÃ³n detectada. La pÃ¡gina se recargarÃ¡ automÃ¡ticamente en 3 segundos perdiendo el cachÃ© antiguo.');
                        setTimeout(() => window.location.reload(), 3000);
                    }
                });
            });
        }
    </script>

</body>

</html>